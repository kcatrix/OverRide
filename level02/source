#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

int main(void)
{
    // Déclaration des variables
    // local_10 dans ton code decompilé
    FILE *file;
    // local_78 (100 bytes)
    char username[100];
    // local_a8 (48 bytes, dont 41 utilisés) - C'est là où le vrai pass est stocké !
    char pass_from_file[48];
    // local_118 (112 bytes)
    char user_pass[112];
    int read_count;

    // 1. Initialisation des buffers à 0 (les boucles for bizarres dans ton code)
    memset(username, 0, 100);
    memset(pass_from_file, 0, 48);
    memset(user_pass, 0, 112);

    // 2. Ouverture du fichier mot de passe
    file = fopen("/home/users/level03/.pass", "r");
    if (file == NULL) {
        fwrite("ERROR: failed to open password file\n", 1, 36, stderr);
        exit(1);
    }

    // 3. Lecture du mot de passe dans 'pass_from_file'
    // 0x29 = 41 bytes
    read_count = fread(pass_from_file, 1, 41, file);
    
    // Supprime le retour à la ligne (\n) s'il y en a un
    pass_from_file[strcspn(pass_from_file, "\n")] = '\0';

    // Vérifie qu'on a bien lu 41 caractères
    if (read_count != 41) {
        fwrite("ERROR: failed to read password file\n", 1, 36, stderr);
        exit(1);
    }

    fclose(file);

    // 4. Interaction Utilisateur
    puts("===== [ Secure Access System v1.0 ] =====");
    puts("/***************************************\\");
    puts("| You must login to access this system. |");
    puts("\\**************************************/");

    // Demande le Username
    printf("--[ Username: ");
    fgets(username, 100, stdin);
    username[strcspn(username, "\n")] = '\0'; // Enlève le \n

    // Demande le Password
    printf("--[ Password: ");
    fgets(user_pass, 100, stdin);
    user_pass[strcspn(user_pass, "\n")] = '\0'; // Enlève le \n

    puts("*****************************************");

    // 5. Comparaison du mot de passe entré avec celui du fichier
    if (strncmp(pass_from_file, user_pass, 41) == 0) {
        printf("Greetings, %s!\n", username);
        system("/bin/sh");
        return 0;
    }

    // 6. LA FAILLE EST ICI !
    // Si le mot de passe est faux, il affiche le username...
    // Mais il utilise printf SANS format string ("%s").
    printf(username); 
    
    puts(" does not have access!");
    exit(1);
}